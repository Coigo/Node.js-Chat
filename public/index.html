<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Node.js Chat</title>
        <link rel="stylesheet" href="./style/index.css">
        <link rel="stylesheet" href="./style/login.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    </head>
    <body>

        <div id="Login" >

                <div id="Loginform">
                    <span onclick="HideFrame('Login')"><i class="fa-solid fa-xmark"></i></span>
                    <input type="text" name="Username" id="Username">
                    <input type="password" name="Password" id="Password">
                    <input type="submit" id="LoginButton">
                    <p class="entreAqui">Não tem uma conta? <span onclick="HideFrame('Login'), ShowFrame('Signin')">Crie uma!</span></p>
                </div>



        </div>
        <div id="Signin" >

                <div id="Signinform">
                    <p id="errorS" style="color: #eb5e28;"></p>
                    <span onclick="HideFrame('Signin')"><i class="fa-solid fa-xmark"></i></span>
                    <input type="text" name="Username" id="CreateUsername">
                    <input type="password" name="Password" id="CreatePassword">
                    <input type="password" name="Confirmation" id="Confirmation">
                    <button type="submit" id="SigninButton"> Criar usuário </button>
                    <p class="entreAqui">Já tem uma conta? <span onclick="HideFrame('Signin'), ShowFrame('Login')">Entre aqui</span></p>
                </div>



        </div>






        <div id="menu" style="position: absolute;">
            <button  onclick="ShowFrame('Login')">Log In</button>
            <button  onclick="ShowFrame('Signin')">Sign In</button>

        </div>

        
        <main id="container">
            <div id="MessageContainer"></div>
            
            <input type="text" name="" id="caixaDeTexto">

        </main>
        
        

<script>



    function ShowFrame(frame) {

                frame = document.getElementById(frame)
                frame.style.display = 'flex'
            }
        
    function HideFrame(frame) {
                frame = document.getElementById(frame)
                frame.style.display = 'none'
    }


</script>

        <script src="/socket.io/socket.io.js"></script> 




        <script type="module">
            import {
                AddMessage, 
                MessageFactory,
                CreateNewUser,
            } 
            from './script/index.js'
            
        import CreateObserver from './script/observer.js'
        import User from './script/user.js'







            const socket = io();
            const Observer = CreateObserver()
            var currentUser


            const MessageContainer = document.getElementById('MessageContainer')
            const MessageContent = document.getElementById('caixaDeTexto')
            const UserNameInput = document.getElementById('UserName')
            const Login = document.getElementById('LoginButton')
            const Signin = document.getElementById('SigninButton')

            MessageContent.addEventListener('keypress', (event) => {

                if (event.key === 'Enter' ) {
                    const MsgJson = MessageFactory(MessageContent.value, currentUser.GetName())

                    Observer.Subscribe(AddMessage)
                    Observer.Subscribe(EmitMessage)
                    Observer.notifyAll(MsgJson)
                    Observer.unSubscribe(AddMessage)
                    Observer.unSubscribe(EmitMessage)
                    

                    MessageContent.value = null

                 }
            

            })  



             socket.on('reenviarMensagem', (MensagemRecebida) => {
                const { msg, UserID } = MensagemRecebida
                AddMessage(msg, UserID)
             })

             socket.on('SendState', (State) => {
                for (let i = 0; i < State.length; i++) {
                    AddMessage(State[i]);
                }
             
         })
            

         
                        Signin.addEventListener("click", () => {
                                const username = document.getElementById("CreateUsername").value
                                const password = document.getElementById("CreatePassword").value
                                const confirmation = document.getElementById("Confirmation").value

                            const NewUserInfo = { username, password, confirmation } 
                            
                            Observer.Subscribe(CreateNewUser)
                            const NewUserStatus =  Observer.notifyAll(NewUserInfo)
                            Observer.unSubscribe(CreateNewUser)
                            
                            const Status = {
                                'SenhasDiferentes' : function () {
                                    console.log('As senhas não conhecidem')
                                },
                                'SenhaCurta' : function () {
                                    console.log('A Senha é fraca')
                                },
                                'TudoCerto' : function () {
                                    socket.emit('CreateNewUser', NewUserInfo )
                                }
                            }
                            console.log(NewUserStatus)
                            const getStatus = Status[NewUserStatus]()
                        })


                        Login.addEventListener('click', () => {
                                const Username = document.getElementById('Username').value
                                const Password = document.getElementById('Password').value

                            const user = { Username, Password }
                                socket.emit('LoginUser', user)
                            
                        })
            

            

        socket.on('usuarioInvalido', (erro) => {
            const errText = document.getElementById('errorS')
            errText.innerHTML = 'Usuário não disponivel. :/'
            setInterval(() => {
                errText.innerHTML = ''
                
            }, 
            3000)
        })


        socket.on('uauarioCriado', () => {
            console.log('usuario Criado')
            HideFrame('Signin'); ShowFrame('Login')
        })

        socket.on('UsuarioLogado', (userInfo) => {
            console.log(userInfo)
            const { Username } = userInfo
            
            currentUser = new User(Username)
            HideFrame('Login')



        })

        function EmitMessage(Message) {
            if (Message.Msg != '') {
                socket.emit('Mensagem', Message)
            }
        }
            
            </script>

            
        

    </body>
</html>